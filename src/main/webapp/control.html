<!DOCTYPE html>
<html>

<head>
    <title>Controller</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div id="connect">
            <form id="connect-form">
                <input type="text" id="host-key" autofocus required>
                <input type="submit" id="connect-btn" value="Connect">
            </form>
        </div>
        
        <div id="connected" class="hidden">
            <h3 id="show-key"></h3>
        </div>
        
        <div class="grid-container">
            <div class="grid-item up">
                <button id="up">^</button>
            </div>
            
            <div class="grid-item left">
                <button id="left">
                    <</button>
            </div>
            
            <div class="grid-item center"></div>
            
            <div class="grid-item right">
                <button id="right">></button>
            </div>
            
            <div class="grid-item down">
                <button id="down">v</button>
            </div>
            
            <div class="grid-item item">
                <h3 id="player"></h3>
            </div>
        </div>
        
        <h3 id="press-any" class="hidden">Press any arrow to spawn snake</h3>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function (event) {
            const up = document.querySelector("#up");
            const down = document.querySelector("#down");
            const left = document.querySelector("#left");
            const right = document.querySelector("#right");
            const player = document.querySelector("#player");
            const connectDiv = document.querySelector("#connect");
            const connectedDiv = document.querySelector("#connected");
            const showKey = document.querySelector("#show-key");
            const connectForm = document.querySelector("#connect-form");
            let hostKey = document.querySelector("#host-key");
            let id;
            let host;
            let wsUrl = document.location.host + "/SnakeLink/actions";
            //let wsUrl = document.location.host + "/actions"
            console.log(wsUrl);
            connectForm.addEventListener('submit', function (e) {
                console.log(hostKey.value);
                if (!hostKey.value) {
                    return false;
                }
                e.preventDefault();
                host = hostKey.value;
                openSocket();
            });
            let socket;
            function openSocket() {
                socket = new WebSocket("ws://" + wsUrl);
                socket.addEventListener("message", function (e) {
                    id = host + " " + e.data;
                    connectDiv.classList.add("hidden");
                    showKey.textContent = "Game: " + host;
                    connectedDiv.classList.remove("hidden");
                    pressAny.classList.remove("hidden");
                    player.textContent = "Player "+e.data;
                })
            }
            const pressAny = document.querySelector("#press-any");
            function hide (){
                if(pressAny.classList.contains("hidden")|| connectedDiv.classList.contains("hidden")){
                    return;
                }else{
                    pressAny.classList.add("hidden")
                }
            }



            down.addEventListener('click', function (e) {
                //hit.textContent = "down";
                socket.send(id + "-down");
                hide();
            });
            //yl√∂s
            up.addEventListener('click', function (e) {
                //hit.textContent = "up";
                socket.send(id + "-up");
                hide();
            });
            //oikea
            right.addEventListener('click', function (e) {
                //hit.textContent = "right";
                socket.send(id + "-right");
                hide();
            });
            //vasen
            left.addEventListener('click', function (e) {
                //hit.textContent = "left";
                socket.send(id + "-left");
                hide();
            });
            window.addEventListener("keydown", function (event) {
                if (event.defaultPrevented) {
                    return; // Do nothing if the event was already processed
                }
                hide();
                switch (event.key) {
                    case "ArrowDown":
                        socket.send(id + "-down");
                        break;
                    case "ArrowUp":
                        socket.send(id + "-up");
                        break;
                    case "ArrowLeft":
                        socket.send(id + "-left");
                        break;
                    case "ArrowRight":
                        socket.send(id + "-right");
                        break;
                    default:
                        return; // Quit when this doesn't handle the key event.
                }
                // Cancel the default action to avoid it being handled twice
                event.preventDefault();
            }, true);
        });
    </script>
</body>

</html>